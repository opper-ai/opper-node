name: Release to NPM

on:
  push:
    branches: [main]
    paths: ['package.json']
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.7.0, 1.0.0)'
        required: true
        type: string
      create_release:
        description: 'Create GitHub release'
        type: boolean
        default: true
      dry_run:
        description: 'Dry run (build but do not publish)'
        type: boolean
        default: false

permissions:
  contents: write
  id-token: write  # For NPM provenance
  pull-requests: read

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      should_release: ${{ steps.check.outputs.should_release }}
      prev_version: ${{ steps.check.outputs.prev_version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Get version from package.json
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=$(node -p "require('./package.json').version")
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Current version: $VERSION"

      - name: Check if version changed
        id: check
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "prev_version=manual" >> $GITHUB_OUTPUT
            echo "ğŸš€ Manual release triggered for version ${{ steps.version.outputs.version }}"
          else
            # Check if version changed in the last commit
            PREV_VERSION=$(git show HEAD~1:package.json | node -p "JSON.parse(require('fs').readFileSync('/dev/stdin', 'utf8')).version" 2>/dev/null || echo "unknown")
            CURR_VERSION="${{ steps.version.outputs.version }}"
            
            echo "prev_version=$PREV_VERSION" >> $GITHUB_OUTPUT
            
            if [ "$PREV_VERSION" != "$CURR_VERSION" ] && [ "$PREV_VERSION" != "unknown" ]; then
              echo "should_release=true" >> $GITHUB_OUTPUT
              echo "ğŸ“ˆ Version changed: $PREV_VERSION â†’ $CURR_VERSION"
            else
              echo "should_release=false" >> $GITHUB_OUTPUT
              echo "â¸ï¸  Version unchanged: $CURR_VERSION"
            fi
          fi

  release:
    needs: check-version
    if: needs.check-version.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    environment: 
      name: ${{ github.event.inputs.dry_run == 'true' && 'dry-run' || 'release' }}
    timeout-minutes: 15
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
          cache: 'npm'

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: |
          echo "ğŸ“¦ Installing dependencies..."
          npm ci
          echo "âœ… Dependencies installed"

      - name: Update version (if manual)
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "ğŸ”„ Updating version to ${{ needs.check-version.outputs.version }}"
          
          # Update version in package.json
          npm version ${{ needs.check-version.outputs.version }} --no-git-tag-version
          
          # Commit the version update
          git config --global user.name "opper-bot"
          git config --global user.email "bot@opper.ai"
          git add package.json
          git commit -m "chore: bump version to ${{ needs.check-version.outputs.version }}"
          git push

      - name: Run quality checks
        run: |
          echo "ğŸ” Running quality checks..."
          
          # Run linting
          echo "  ğŸ§¹ Running ESLint..."
          npm run lint
          echo "  âœ… Linting passed"
          
          # Run TypeScript type checking
          echo "  ğŸ”§ Running TypeScript type check..."
          npx tsc --noEmit
          echo "  âœ… Type checking passed"

      - name: Build package
        run: |
          echo "ğŸ”¨ Building package..."
          
          # Build MCP server
          echo "  ğŸ—ï¸  Building MCP server..."
          npm run build:mcp
          
          # Build main package
          echo "  ğŸ—ï¸  Building main package..."
          npm run build
          
          echo "âœ… Build completed successfully"

      - name: Validate build artifacts
        run: |
          echo "ğŸ” Validating build artifacts..."
          
          # Check CommonJS output
          if [ -d "dist/commonjs" ]; then
            echo "  âœ… CommonJS output found"
            ls -la dist/commonjs/ | head -10
          else
            echo "  âŒ CommonJS output missing"
            exit 1
          fi
          
          # Check ESM output
          if [ -d "dist/esm" ]; then
            echo "  âœ… ESM output found"
            ls -la dist/esm/ | head -10
          else
            echo "  âŒ ESM output missing"
            exit 1
          fi
          
          # Check MCP server binary
          if [ -f "bin/mcp-server.js" ]; then
            echo "  âœ… MCP server binary found"
            echo "  ğŸ“ MCP server size: $(du -h bin/mcp-server.js | cut -f1)"
          else
            echo "  âŒ MCP server binary missing"
            exit 1
          fi
          
          # Verify package contents
          echo "  ğŸ“¦ Package contents preview:"
          npm pack --dry-run | head -20

      - name: Run smoke tests
        run: |
          echo "ğŸ§ª Running smoke tests..."
          
          # Test CommonJS import
          node -e "
            try {
              const { Opper } = require('./dist/commonjs/index.js');
              const client = new Opper({ httpBearer: 'test' });
              console.log('âœ… CommonJS import and instantiation successful');
            } catch (error) {
              console.error('âŒ CommonJS test failed:', error.message);
              process.exit(1);
            }
          "
          
          # Test ESM import (using dynamic import in CommonJS context)
          node -e "
            (async () => {
              try {
                const { Opper } = await import('./dist/esm/index.js');
                const client = new Opper({ httpBearer: 'test' });
                console.log('âœ… ESM import and instantiation successful');
              } catch (error) {
                console.error('âŒ ESM test failed:', error.message);
                process.exit(1);
              }
            })();
          "
          
          echo "âœ… Smoke tests passed"

      - name: Publish to NPM
        if: github.event.inputs.dry_run != 'true'
        run: |
          echo "ğŸš€ Publishing to NPM..."
          
          # Show what will be published
          echo "ğŸ“¦ Package info:"
          npm pack --dry-run | head -10
          
          # Publish with provenance
          if npm publish --access public --provenance; then
            echo "âœ… Successfully published to NPM"
            
            # Show published package info
            VERSION="${{ needs.check-version.outputs.version }}"
            echo "ğŸ”— NPM Package: https://www.npmjs.com/package/opperai/v/$VERSION"
          else
            echo "âŒ NPM publish failed"
            exit 1
          fi

      - name: Create GitHub Release
        if: github.event.inputs.create_release != 'false' && github.event.inputs.dry_run != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ needs.check-version.outputs.version }}"
          PREV_VERSION="${{ needs.check-version.outputs.prev_version }}"
          TAG_NAME="v$VERSION"
          
          echo "ğŸ·ï¸  Creating GitHub release $TAG_NAME..."
          
          # Create the tag
          git tag "$TAG_NAME"
          git push origin "$TAG_NAME"
          
          # Generate changelog if we have a previous version
          CHANGELOG=""
          if [ "$PREV_VERSION" != "manual" ] && [ "$PREV_VERSION" != "unknown" ]; then
            PREV_TAG="v$PREV_VERSION"
            if git tag | grep -q "^$PREV_TAG$"; then
              echo "ğŸ“ Generating changelog from $PREV_TAG to $TAG_NAME..."
              CHANGELOG=$(git log --pretty=format:"- %s (%h)" "$PREV_TAG..$TAG_NAME" | head -20)
            fi
          fi
          
          # Generate release notes
          RELEASE_NOTES="$(cat <<EOF
          ## ğŸš€ Opper AI TypeScript SDK v$VERSION
          
          This release contains the latest updates to the Opper AI TypeScript/Node.js SDK.
          
          ### ğŸ“¦ Installation
          \`\`\`bash
          npm install opperai@$VERSION
          # or
          yarn add opperai@$VERSION
          # or
          pnpm add opperai@$VERSION
          \`\`\`
          
          ### ğŸ”§ Features
          - âœ… TypeScript SDK with full type safety
          - âœ… CommonJS and ESM module support
          - âœ… Model Context Protocol (MCP) server included
          - âœ… Standalone functions for tree-shaking
          - âœ… Comprehensive API coverage
          
          $(if [ -n "$CHANGELOG" ]; then echo "### ğŸ“‹ Changes in this release"; echo "$CHANGELOG"; fi)
          
          ### ğŸ”— Links
          - [NPM Package](https://www.npmjs.com/package/opperai/v/$VERSION)
          - [Documentation](https://docs.opper.ai)
          - [API Reference](https://github.com/opper-ai/opper-node-speakeasy/tree/main/docs)
          - [Examples](https://github.com/opper-ai/opper-node-speakeasy#usage)
          
          ### ğŸ¤– SDK Information
          This SDK is automatically generated from OpenAPI specifications using Speakeasy with TypeScript optimizations.
          
          - **Generated**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          - **Package Size**: $(npm pack --dry-run 2>/dev/null | tail -1 | grep -o '[0-9.]*[kM]B' || echo 'N/A')
          - **Module Formats**: CommonJS + ESM
          - **TypeScript**: Full type definitions included
          
          ---
          
          **Full Changelog**: https://github.com/opper-ai/opper-node-speakeasy/compare/v$PREV_VERSION...v$VERSION
          EOF
          )"
          
          # Create the release
          gh release create "$TAG_NAME" \
            --title "ğŸš€ Opper AI TypeScript SDK v$VERSION" \
            --notes "$RELEASE_NOTES" \
            --latest
          
          echo "âœ… GitHub release created: https://github.com/opper-ai/opper-node-speakeasy/releases/tag/$TAG_NAME"

      - name: Post-release summary
        run: |
          VERSION="${{ needs.check-version.outputs.version }}"
          PREV_VERSION="${{ needs.check-version.outputs.prev_version }}"
          
          echo ""
          echo "ğŸ‰ Release Summary"
          echo "=================="
          echo "ğŸ“¦ Version: $VERSION"
          if [ "$PREV_VERSION" != "manual" ] && [ "$PREV_VERSION" != "unknown" ]; then
            echo "â¬†ï¸  Upgraded from: $PREV_VERSION"
          fi
          echo "ğŸ—ï¸  Build: âœ… Successful"
          echo "ğŸ§ª Tests: âœ… Passed"
          
          if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
            echo "ğŸš« Dry run: Package built but not published"
          else
            echo "ğŸ“¤ NPM: âœ… Published"
            echo "ğŸ”— NPM: https://www.npmjs.com/package/opperai/v/$VERSION"
            
            if [ "${{ github.event.inputs.create_release }}" != "false" ]; then
              echo "ğŸ·ï¸  GitHub Release: âœ… Created"
              echo "ğŸ”— Release: https://github.com/opper-ai/opper-node-speakeasy/releases/tag/v$VERSION"
            fi
          fi
          
          echo ""
          echo "ğŸ¯ Next steps:"
          echo "  1. Verify package is available on NPM"
          echo "  2. Test installation in a fresh project"
          echo "  3. Update any dependent projects"
          echo "  4. Announce the release if needed"

  dry-run-summary:
    needs: [check-version, release]
    if: github.event.inputs.dry_run == 'true' && needs.check-version.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Dry run summary
        run: |
          echo "ğŸš« DRY RUN COMPLETED"
          echo "==================="
          echo "This was a dry run - no packages were published."
          echo ""
          echo "ğŸ“¦ Version: ${{ needs.check-version.outputs.version }}"
          echo "âœ… Build: Successful"
          echo "âœ… Tests: Passed"
          echo "ğŸš« NPM: Not published (dry run)"
          echo "ğŸš« GitHub Release: Not created (dry run)"
          echo ""
          echo "To publish for real, run the workflow again with 'dry_run: false'"