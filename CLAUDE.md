# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Key Commands

### Development Commands
- `npm run build` - Build the entire project (includes MCP server build + tshy compilation)
- `npm run build:mcp` - Build only the MCP server using Bun
- `npm run lint` - Run ESLint with cache and fail on warnings
- `npm run prepublishOnly` - Prepare package for publishing (runs build)

### Testing Commands
- `npx tsx test-opper.ts` - Run comprehensive SDK test suite
- `npx tsx test-streaming.ts` - Test streaming functionality
- `npx tsx test-examples.ts` - Test embeddings examples
- `OPPER_API_KEY=your-key npx tsx test-opper.ts` - Run tests with custom API key

### MCP Server Commands
- `npx -y --package opperai -- mcp start --help` - Show MCP server help
- `npx -y --package opperai -- mcp start --http-bearer TOKEN` - Start MCP server

## Architecture Overview

### Generated Code Structure
This SDK is **generated by Speakeasy** - most source files are auto-generated and should not be manually edited. Look for the comment `Code generated by Speakeasy (https://speakeasy.com). DO NOT EDIT.` at the top of files.

### Core SDK Components
- **Main SDK Class**: `src/sdk/sdk.ts` - Main `Opper` class with all API resources
- **Standalone Functions**: `src/funcs/` - Tree-shakeable standalone functions for each API operation
- **Models**: `src/models/` - TypeScript interfaces and types for all API schemas
- **Operations**: `src/models/operations/` - Request/response types for each endpoint
- **Core Client**: `src/core.ts` - Base client class (`OpperCore`) for standalone functions

### API Resources Structure
The SDK exposes these main API resources through the `Opper` class:
- `knowledge` - Knowledge base management and RAG operations
- `functions` - AI function creation, execution, and management
- `traces` - Execution tracing and observability
- `spans` - Span management for detailed tracing
- `spanMetrics` - Metrics collection on spans
- `datasets` - Dataset management for training/evaluation
- `embeddings` - Text embedding generation
- `languageModels` - Language model management
- `openai` - OpenAI-compatible chat completions
- `analytics` - Usage analytics and reporting

### MCP Server Integration
This SDK includes a full MCP (Model Context Protocol) server implementation:
- **Entry Point**: `src/mcp-server/mcp-server.ts` - CLI application using @stricli/core
- **Server Logic**: `src/mcp-server/server.ts` - MCP server creation and tool registration
- **Tools**: `src/mcp-server/tools/` - Individual MCP tools for each SDK function
- **Binary**: `bin/mcp-server.js` - Executable MCP server (large generated file)

### Dual API Patterns
The SDK supports two usage patterns:
1. **Main SDK Class**: `new Opper()` - Full SDK with all resources
2. **Standalone Functions**: Import individual functions for tree-shaking in browsers/serverless

### Error Handling
- **Base Error**: `OpperError` - Base class for all HTTP errors
- **Specific Errors**: `BadRequestError`, `UnauthorizedError`, `NotFoundError`, etc.
- **Standalone Functions**: Return `Result<Value, Error>` instead of throwing

## Development Patterns

### Authentication
Uses HTTP Bearer token authentication via `OPPER_HTTP_BEARER` environment variable or `httpBearer` config option.

### Configuration
- **Server URL**: Configurable via `serverURL` option (defaults to https://api.opper.ai/v2)
- **Environment Variables**: `OPPER_HTTP_BEARER`, `OPPER_SERVER_URL`, `OPPER_DEBUG`

### Streaming Support
The SDK supports Server-Sent Events streaming via:
- `opper.stream()` method
- `opper.functions.stream()` method
- Returns async iterables for `for await...of` loops

### TypeScript Configuration
- **Target**: ES2020 with Node16 modules
- **Strict Mode**: Enabled with additional strict checks
- **Build System**: Uses `tshy` for dual ESM/CommonJS output

### Testing Architecture
Test files demonstrate comprehensive SDK usage:
- **Basic Operations**: Simple call/stream tests
- **Knowledge Base**: RAG workflows with document indexing and querying  
- **Complex Workflows**: Multi-step AI workflows combining multiple resources
- **Resource Management**: Automatic cleanup of created resources

## Key Implementation Details

### Schema Definitions
Input/output schemas use JSON Schema format, not TypeScript interfaces directly. See test files for examples of proper schema definition.

### Retries and Error Handling
SDK includes built-in retry logic with configurable backoff strategies. Can be customized globally or per-operation.

### HTTP Client Hooks
Supports custom HTTP client with hooks for request/response manipulation and error handling.

### Bundle Optimization
Standalone functions and `OpperCore` provide significant bundle size benefits for browser/serverless environments through tree-shaking.